name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort
          pip install -r smart_energy_controller/requirements.txt

      - name: Run Black (code formatter check)
        run: |
          black --check --diff app/ tests/

      - name: Run isort (import sorting check)
        run: |
          isort --check-only --diff app/ tests/

      - name: Run Flake8 (linting)
        run: |
          flake8 app/ tests/ --max-line-length=120 --extend-ignore=E203,W503

      - name: Run Pylint (static analysis)
        run: |
          pylint app/ --max-line-length=120 --disable=C0111,R0913,R0914,R0915,R0912,W0718,C0103,R0801
        continue-on-error: true

  lint-javascript:
    name: Lint JavaScript Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint
        run: |
          npm install -g eslint

      - name: Run ESLint
        run: |
          eslint app/static/*.js --no-eslintrc --env browser,es2021 --parser-options ecmaVersion:2021
        continue-on-error: true

  test-python:
    name: Run Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r smart_energy_controller/requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests with pytest
        run: |
          python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
        continue-on-error: true

  validate-config:
    name: Validate Add-on Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate repository.json syntax
        run: |
          python -m json.tool repository.json > /dev/null
          echo "✓ repository.json is valid JSON"

      - name: Validate config.json syntax
        run: |
          python -m json.tool smart_energy_controller/config.json > /dev/null
          echo "✓ config.json is valid JSON"

      - name: Check config.json schema
        run: |
          python -c "
          import json
          with open('smart_energy_controller/config.json') as f:
              config = json.load(f)
          required_keys = ['name', 'version', 'slug', 'description', 'arch']
          for key in required_keys:
              assert key in config, f'Missing required key: {key}'
          print('✓ config.json has all required keys')
          "

      - name: Validate Dockerfile syntax
        run: |
          docker run --rm -i hadolint/hadolint < smart_energy_controller/Dockerfile
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run Safety (dependency vulnerability check)
        run: |
          pip install -r smart_energy_controller/requirements.txt
          safety check --json
        continue-on-error: true

      - name: Run Bandit (security linting)
        run: |
          bandit -r app/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
        if: always()

  docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./smart_energy_controller
          file: ./smart_energy_controller/Dockerfile
          push: false
          tags: smart-energy-controller:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  addon-validator:
    name: Home Assistant Add-on Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Home Assistant Add-on Lint
        uses: frenck/action-addon-linter@v2
        with:
          path: "./smart_energy_controller"

  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for required documentation files
        run: |
          required_files=("README.md" "smart_energy_controller/CHANGELOG.md" "smart_energy_controller/DOCS.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            else
              echo "✓ Found $file"
            fi
          done

      - name: Check documentation links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-python, lint-javascript, test-python, validate-config, security-scan, docker-build, addon-validator]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Lint Python: ${{ needs.lint-python.result }}"
          echo "Lint JavaScript: ${{ needs.lint-javascript.result }}"
          echo "Test Python: ${{ needs.test-python.result }}"
          echo "Validate Config: ${{ needs.validate-config.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo "Add-on Validator: ${{ needs.addon-validator.result }}"
          
          if [ "${{ needs.lint-python.result }}" != "success" ] || \
             [ "${{ needs.test-python.result }}" != "success" ] || \
             [ "${{ needs.validate-config.result }}" != "success" ] || \
             [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "❌ One or more critical checks failed"
            exit 1
          fi
          
          echo "✓ All critical checks passed"
